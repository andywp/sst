<?php if (!defined('basePath')) exit('No direct script access allowed');
include 'excel_reader2.php';

$pIsi2 ='<table cellpadding="0" cellspacing="0" class="wrapper" style="font-family:trebuchet ms,verdana; width:100%">
	<tbody>
		<tr>
			<td>
			<table cellpadding="0" cellspacing="0" style="width:100%">
				<tbody>
					<tr>
						<td>Email not displaying correctly? <a href="#" style="color:#fff">View it in your browser.</a></td>
					</tr>
					<tr>
						<td><br />
						&nbsp;</td>
					</tr>
				</tbody>
			</table>

			<table align="center" border="0" cellpadding="0" cellspacing="0" class="main-content-wrap" style="border-top:none; border:1px solid #eee; box-shadow:0 3px 3px 0 #ddd; width:640px">
				<tbody>
					<tr>
						<td>&nbsp;
						<table align="center" cellpadding="0" cellspacing="0" style="width:580px">
							<tbody>
								<tr>
									<td><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/Logo-AON-Insurer.jpg" style="height:127px; width:217px" /></td>
								</tr>
							</tbody>
						</table>
						</td>
					</tr>
					<tr>
						<td>&nbsp;
						<table align="center" cellpadding="0" cellspacing="0" style="width:580px">
							<tbody>
								<tr>
									<td>
									<hr /></td>
									<td>
									<h1 style="text-align: center;">March 2015</h1>
									</td>
									<td>
									<hr /></td>
								</tr>
							</tbody>
						</table>
						&nbsp;

						<table align="center" cellpadding="0" cellspacing="0" style="color:#666; font-size:13px; width:580px">
							<tbody>
								<tr>
									<td><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/img1.jpg" style="width:580px" /></td>
								</tr>
								<tr>
									<td>&nbsp;
									<h2 style="text-align:center">DARI REDAKSI</h2>
									<em>Halo, Salam Hasan..</em>

									<p><em>Lorem ipsum</em> dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. <em>Lorem ipsum</em> dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat</p>

									<p><em>Lorem ipsum</em> dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. <em>Lorem ipsum</em> dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. <em>Lorem ipsum</em> dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat</p>
									</td>
								</tr>
								<tr>
									<td>&nbsp;
									<hr /></td>
								</tr>
								<tr>
									<td>
									<table cellpadding="0" cellspacing="0" style="color:#666; font-size:13px; width:580px">
										<tbody>
											<tr>
												<td>
												<h2>PROFIL PARTNER</h2>
												<a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/img1.jpg" style="width:280px" /></a>

												<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed adipiscing vulputate lacus at vulputate. In mattis magna id lobortis consequat.</p>
												<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
												<td>&nbsp;</td>
												<td>
												<h2>PROFIL PERUSAHAAN</h2>
												<a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/img1.jpg" style="width:280px" /></a>

												<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed adipiscing vulputate lacus at vulputate. In mattis magna id lobortis consequat.</p>
												<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
											</tr>
											<tr>
												<td colspan="3"><br />
												&nbsp;</td>
											</tr>
											<tr>
												<td>
												<h2>PROFIL PRODUSEN</h2>
												<a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/img1.jpg" style="width:280px" /></a>

												<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed adipiscing vulputate lacus at vulputate. In mattis magna id lobortis consequat.</p>
												<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
												<td>&nbsp;</td>
												<td>
												<h2>STOVE TESTING</h2>
												<a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/img1.jpg" style="width:280px" /></a>

												<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed adipiscing vulputate lacus at vulputate. In mattis magna id lobortis consequat.</p>
												<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
											</tr>
											<tr>
												<td colspan="3">&nbsp;</td>
											</tr>
										</tbody>
									</table>

									<table cellpadding="0" cellspacing="0" style="color:#666; font-size:13px; width:580px">
										<tbody>
											<tr>
												<td>&nbsp;
												<hr /></td>
											</tr>
											<tr>
												<td>
												<h2 style="text-align:center">UPCOMING EVENTS</h2>
												</td>
											</tr>
											<tr>
												<td>
												<table cellpadding="0" cellspacing="0" style="color:#666; font-size:13px; width:580px">
													<tbody>
														<tr>
															<td>
															<h4><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/icon-calender.png" style="float:left; margin:7px 10px 0 0" /> 24 Juni 2015</h4>

															<h2><a href="#" style="text-decoration:none;color:#333">Lorem ipsum dolor sit amet</a></h2>

															<p>Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat. Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat.</p>
															<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
															<td>&nbsp;</td>
															<td>
															<h4><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/icon-calender.png" style="float:left; margin:7px 10px 0 0" /> 25 Juni 2015</h4>

															<h2><a href="#" style="text-decoration:none;color:#333">Lorem ipsum dolor sit amet</a></h2>

															<p>Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat. Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat.</p>
															<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
														</tr>
													</tbody>
												</table>
												</td>
											</tr>
											<tr>
												<td colspan="3">&nbsp;</td>
											</tr>
											<tr>
												<td>&nbsp;
												<hr /></td>
											</tr>
											<tr>
												<td>
												<h2 style="text-align:center">ARTIKEL</h2>
												</td>
											</tr>
											<tr>
												<td>&nbsp;
												<hr /></td>
											</tr>
											<tr>
												<td>
												<table cellpadding="0" cellspacing="0" style="color:#666; font-size:13px; width:580px">
													<tbody>
														<tr>
															<td>
															<h2><a href="#" style="text-decoration:none;color:#333">Kasus Kompor Biomassa Bersih di Indonesia</a></h2>
															<small>12 Mei 2014 | John Doe</small>

															<p>Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat. Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat.</p>
															<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/article1.jpg" style="width:210px" /></a></td>
														</tr>
														<tr>
															<td colspan="3">&nbsp;
															<hr /></td>
														</tr>
														<tr>
															<td>
															<h2><a href="#" style="text-decoration:none;color:#333">Kasus Kompor Biomassa Bersih di Indonesia</a></h2>
															<small>12 Mei 2014 | John Doe</small>

															<p>Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat. Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat.</p>
															<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:210px" /></a></td>
														</tr>
														<tr>
															<td colspan="3">&nbsp;
															<hr /></td>
														</tr>
														<tr>
															<td>
															<h2><a href="#" style="text-decoration:none;color:#333">Kasus Kompor Biomassa Bersih di Indonesia</a></h2>
															<small>12 Mei 2014 | John Doe</small>

															<p>Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat. Consectetur adipiscing elit. Phasellus a ipsum a risus volutpat.</p>
															<a href="#" style="background:#C5AB3D;padding:5px 10px;color:#fff;text-decoration:none;display:inline-block;">Read more &raquo;</a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/article1.jpg" style="width:210px" /></a></td>
														</tr>
													</tbody>
												</table>
												</td>
											</tr>
											<tr>
												<td>&nbsp;
												<hr /></td>
											</tr>
											<tr>
												<td>
												<h2 style="text-align:center">PHOTO OF THE MONTH</h2>
												</td>
											</tr>
											<tr>
												<td>
												<table cellpadding="0" cellspacing="0" style="color:#666; font-size:13px; width:580px">
													<tbody>
														<tr>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:136px" /></a></td>
														</tr>
														<tr>
															<td colspan="7">&nbsp;</td>
														</tr>
														<tr>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/photo-gallery1.jpg" style="width:136px" /></a></td>
														</tr>
													</tbody>
												</table>
												</td>
											</tr>
											<tr>
												<td>&nbsp;
												<hr /></td>
											</tr>
											<tr>
												<td>
												<h2 style="text-align:center">MITRA KAMI</h2>
												</td>
											</tr>
											<tr>
												<td>
												<table cellpadding="0" cellspacing="0" style="color:#666; font-size:13px; width:580px">
													<tbody>
														<tr>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/partner-logo.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/partner-logo.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/partner-logo.jpg" style="width:136px" /></a></td>
															<td>&nbsp;</td>
															<td><a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/partner-logo.jpg" style="width:136px" /></a></td>
														</tr>
													</tbody>
												</table>
												</td>
											</tr>
											<tr>
												<td><br />
												<br />
												<a href="#" style="margin-right:10px;display:inline-block;text-decoration:none;color:333">Beranda</a> <a href="#" style="margin-right:10px;display:inline-block;text-decoration:none;color:333">Tentang Kami</a> <a href="#" style="margin-right:10px;display:inline-block;text-decoration:none;color:333">Teknologi</a> <a href="#" style="margin-right:10px;display:inline-block;text-decoration:none;color:333">Artikel</a> <a href="#" style="margin-right:10px;display:inline-block;text-decoration:none;color:333">Forum</a> <a href="#" style="margin-right:10px;display:inline-block;text-decoration:none;color:333">Anggota</a> <a href="#" style="margin-right:10px;display:inline-block;text-decoration:none;color:333">FAQ</a> <a href="#" style="display:inline-block;text-decoration:none;color:333">Kontak</a></td>
											</tr>
											<tr>
												<td><br />
												Having trouble viewing this email? See this deal on <a href="#">our website.</a></td>
											</tr>
											<tr>
												<td><br />
												<br />
												Has this newsletter been forwarded to you? Subscribe to Hasan Indonesia newsletter<br />
												Rather not receive it anymore? <a href="#">Unsubscribe</a></td>
											</tr>
											<tr>
												<td>&nbsp;
												<hr /></td>
											</tr>
											<tr>
												<td><a href="#" style="margin-right:5px"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/icon-facebook.png" style="height:41px; width:41px" /></a> <a href="#" style="margin-right:5px"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/icon-twitter.png" style="height:41px; width:42px" /></a> <a href="#"><img alt="" src="http://demo.citraweb.co.id/New_cms/awp-content/uploads/files/images/icon-g-pluss.png" style="height:41px; width:43px" /></a><br />
												&nbsp;</td>
											</tr>
										</tbody>
									</table>
									</td>
								</tr>
							</tbody>
						</table>
						</td>
					</tr>
				</tbody>
			</table>
			</td>
		</tr>
	</tbody>
</table>';


/* Send Email */
if(isset($_POST['submit'])){
	
	if(empty($_POST['subject'])){
		$alert = $this->form->alert('warning','Subject cannot be empty');
	}
	elseif(empty($_POST['message'])){
		$alert = $this->form->alert('warning','Message cannot be empty');
	}
	else{
	    if (@move_uploaded_file($_FILES['file_excel']['tmp_name'], tmpPath.$_SESSION['admin']['id'].'.xls')) {
		$file=tmpPath.$_SESSION['admin']['id'].'.xls';
		$data = new Spreadsheet_Excel_Reader($file);
		$jmlbaris = $data->rowcount(0);
		$getMember=array();
					for ($i=1; $i<=$jmlbaris; $i++)
					{   
						$getMember[]['email']= $data->val($i, 1, 0);
					}	
		}
		//adodb_pr($getMember);
		//$getMember = $this->db->getAll("select id,email,auth from ".$this->table_prefix."newsletter where status ='1' limit ".$xmember.",".$limit."");
	    $sks=0;
		$ggl=0;
		foreach($getMember as $mail){
		

			@$_POST['unsubscribelink'] = '<a href="'.$unsubscribeUrl.'">unsubscribe</a>';
			$sendmail['subject'] 	= $_POST['subject'];
			$sendmail['cc'] 		= '';
			$sendmail['bcc'] 		= '';
			$sendmail['from'] 		= $_POST['from_email'];
			$sendmail['from_name'] 	= $_POST['from_name'];
			$sendmail['content'] 	= perbaharuipath($this->replaceEmailContent(stripslashes($_POST['message']),$_POST));
			$sendmail['server']     = $_POST['emailtype'];
			$sendmail['to'] = $mail['email'];
			
			
			$kirim=$this->sendMailNewsletter($sendmail);
			//adodb_pr($sendmail);
			$this->db->execute("insert ".$this->table_prefix."newsletter_detail set tanggal=now(),
			judul='".$_POST['subject']."',
			pengirim='".$_POST['from_name']." <".$_POST['from_email'].">',
			email='".$sendmail['to']."',
			pesan='".htmlentities($sendmail['content'])."',
			status='".$kirim."',
			user='".$_SESSION['admin']['id']."',
			server='".$_POST['emailtype']."'");
			if($kirim=="success"){
				$sks++;
			}
			else{
			   $ggl++;
			}
			
			echo "<br> insert ".$this->table_prefix."newsletter_detail set tanggal=now(),
			judul='".$_POST['subject']."',
			pengirim='".$_POST['from_name']." <".$_POST['from_email'].">',
			email='".$sendmail['to']."',
			status='".$kirim."',
			user='".$_SESSION['admin']['id']."',
			server='".$_POST['emailtype']."'";
		}
		
		// Update Params
		$xdate 		= date('Y-m-d h:i:s');
		$sendDate	= array('sendDate' => $xdate);
		
		//$this->db->execute("update ".$this->table_prefix."params set newsletter ='".serialize($sendDate)."'");
		$this->db->execute("insert ".$this->table_prefix."statistik set tanggal=now(),sukses='".$sks."',gagal='".$ggl."',user='".$_SESSION['admin']['id']."',server='".$_POST['emailtype']."'");
		$alert = $this->form->alert('success','Email has been sent');
	}
}
?>
<?=@$alert;?>
<script type="text/javascript" src="<?=systemURL?>form/ckeditor/ckeditor/ckeditor.js"></script>

<div class="row">
	<form name="sendNewsletter" action="" method="post" enctype="multipart/form-data">
	<input type="hidden" name="emailtype" value="local">
    <div class="col-md-7">
        <div class="form-group">
        	<label class="control-label">Send to</label>
            <div class="controls">
            	<input type="file" name="file_excel">
            </div>
        </div>
    </div>
	<div class="clearfix"></div>
    <div class="col-md-4">
        <div class="form-group">
        	<label class="control-label">From Email</label>
            <div class="controls">
            	<input type="text" class="form-control validateText" value="info@domail.com" name="from_email">
            </div>
        </div>
    </div>
	<div class="clearfix"></div>
    <div class="col-md-4">
        <div class="form-group">
        	<label class="control-label">From Name</label>
            <div class="controls">
            	<input type="text" class="form-control validateText" value="Info" name="from_name">
            </div>
        </div>
    </div>
	<div class="clearfix"></div>
    <div class="col-md-6">
        <div class="form-group">
        	<label class="control-label">Subject</label>
            <div class="controls">
            	<input type="text" class="form-control validateText" value="" name="subject">
            </div>
        </div>
    </div>
    <div class="col-md-12">
        <div class="form-group">
        	<label class="control-label">Message</label>
            <div class="controls">
            	<textarea class="ckeditor" name="message" id="message"><?=$pIsi2?></textarea>
            </div>
        </div>
    </div>

    <div class="col-md-12">
        <button id="save_product" name="submit" class="btn btn-sm btn-primary" type="submit"><i class="fa fa-plus"></i> Send Newsletter</button>
    </div>
	</form>    
</div>
<script type="text/javascript">
    CKEDITOR.replace("message");
</script>
